<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html"
				xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core"
				xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
				xmlns:o="http://omnifaces.org/ui" xmlns:sysinf="http://argustelecom.ru/system-inf"
				xmlns:pm="http://primefaces.org/modena" xmlns:f="http://java.sun.com/jsf/core"
				xmlns:boxenv="http://argustelecom.ru/box/env">

	<f:loadBundle var="subscriptionBundle" basename="SubscriptionBundle"/>
	<p:outputPanel rendered="#{p:ifGranted('Billing_SubscriptionView')}">
		<div class="#{containerClass eq null ? 'm-container100' : containerClass} m-responsive100">
			<div class="m-container-indent">
				<div class="m-card m-shadow-effect m-hei-auto-on-mobile simple-fb">
					<h:form id="subscriptions_form">

						<f:event type="preRenderComponent" listener="#{subscriptionsFm.preRender(personalAccount)}"/>

						<div class="ui-dashboard-header">
							<i class="icon-dehaze"/>
							<h:outputText value="#{subscriptionBundle['box.subscription.plural']}" styleClass="card-header"/>

							<p:outputPanel styleClass="m-fright">
								<p:selectBooleanCheckbox id="show_terminated" value="#{subscriptionsFm.showTerminated}"
														 itemLabel="#{subscriptionBundle['box.subscription.box.show_close']}">
									<p:ajax process="@this" update="subscriptions_table"/>
								</p:selectBooleanCheckbox>

								<p:commandLink id="sub_creation_button" styleClass="m-mar-left10" process="@this"
											   title="#{overallBundle['box.overall.add']}"
												action="#{subscriptionCreationByContractDm.onCreationDialogOpened()}"
												disabled="#{not (subscriptionsFm.canCreateSubscription() and p:ifGranted('Billing_SubscriptionEdit'))}">
												<i class="fa fa-edit icon-btn"/>
												<f:setPropertyActionListener value="#{subscriptionsFm.createdCallback}"
																			target="#{subscriptionCreationByContractDm.callback}"/>
												<f:setPropertyActionListener value="#{subscriptionsFm.personalAccount}"
																			target="#{subscriptionCreationByContractDm.personalAccount}"/>
								</p:commandLink>

							</p:outputPanel>
						</div>

						<o:importConstants type="ru.argustelecom.box.env.billing.subscription.model.SubscriptionState" var="subsState"/>

						<p:dataTable id="subscriptions_table" value="#{subscriptionsFm.subscriptions}" var="subscription"
									 paginator="true" tableStyle="table-layout: auto;" rowsPerPageTemplate="5,10,15"
									 rows="5" paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
									 currentPageReportTemplate="{startRecord} - {endRecord} #{overallBundle['box.overall.from']} {totalRecords}"
									 styleClass="paginator-top-hidden" rowKey="#{subscription.id}"
									 emptyMessage="#{overallBundle['box.overall.empty']}">

							<p:column headerText="#{overallBundle['box.overall.id']}">
								<boxenv:linkToCard value="#{subscription.getIdentifiable()}" text="#{subscription.id}"/>
							</p:column>

							<p:column headerText="#{subscriptionBundle['box.subscription.product']}">
								<h:outputText value="#{subscription.productName}"/>
							</p:column>

							<p:column headerText="#{subscriptionBundle['box.subscription.pricelist']}">
								<boxenv:linkToCard text="#{subscription.costCauseName}" value="#{subscription.getIdentifiable().costCause.pricelist}"/>
							</p:column>

							<p:column headerText="#{subscriptionBundle['box.subscription.amount']}">
								<div class="columns">
									<div class="column">
										<boxenv:money value="#{subscription.cost}" unicolour="true" size="fs14" styleClass="m-mar-right3"/>
									</div>
									<div class="column">
										<h:outputText id="costttp" class="icon-info_outline tooltip tooltip-help tooltip-help-3"
													  position="top"
													  title="#{subscriptionBundle['box.subscription.provision.term']}: #{subscription.provisionTerms.name}&#013;#{overallBundle['box.overall.desc']}: #{subscription.provisionTerms.description}"/>
										<p:tooltip id="ttp" for="costttp" />
									</div>
								</div>
							</p:column>

							<p:column headerText="#{overallBundle['box.overall.desc']}">
								<boxenv:linkToCard value="#{subscription.getIdentifiable().subjectCause.contractEntry.contract}"
												   text="#{subscription.subjectCause.name}"
												   rendered="#{!subscription.subjectCause.type.equals(causeType.ORDER)}"/>
							</p:column>

							<p:column headerText="#{overallBundle['box.overall.state']}">
								<h:outputText value="#{subscription.state.name}"/>
							</p:column>

							<p:column headerText="#{overallBundle['box.overall.valid_from']}">
								<h:outputText value="#{subscription.validFrom}">
									<sysinf:convertDateTime pattern="#{dateUtils.DATETIME_DEFAULT_PATTERN}"/>
								</h:outputText>
								<ui:fragment rendered="#{subscription.hasPrivilege()}">
									<i class="fa fa-hourglass-half m-mar-left10 m-orange" title="#{subscription.privilegeInfo}"/>
								</ui:fragment>
							</p:column>

							<p:column headerText="#{overallBundle['box.overall.valid_to']}">
								<h:outputText value="#{subscription.validTo}">
									<sysinf:convertDateTime pattern="#{dateUtils.DATETIME_DEFAULT_PATTERN}"/>
								</h:outputText>
							</p:column>

							<p:column headerText="#{subscriptionBundle['box.subscription.provision.address']}">
								<ui:repeat value="#{subscription.locations}" var="location">
									<h:outputText value="#{location}"/>
								</ui:repeat>
							</p:column>

							<p:column headerText="#{subscriptionBundle['box.subscription.service.plural']}">
								<div class="m-disp-table-cell width-98-percents">
									<ui:fragment rendered="#{subscription.hasOneService()}">
										<!--TODO: раскоментировать при реализации карточки услуг-->
										<!--<boxenv:linkToCard value="#{entry.services.services}" text="#{entry.services.services.name}"/>-->
										<h:outputText value="#{subscription.firstService.name}"/>
									</ui:fragment>

									<ui:fragment rendered="#{subscription.hasSeveralServices()}">
										<h:outputText value="#{subscription.firstService.name},..." styleClass="m-disp-block"/>
										<p:commandLink id="imageBtn" title="#{contractBundle['box.contract.entry.show_all']}"
													   value="#{overallBundle['box.overall.total']} #{subscription.services.size()}" />

										<p:overlayPanel id="imagePanel" for="imageBtn" hideEffect="fade" styleClass="panel">
											<ui:repeat value="#{subscription.services}" var="serviceItem">
												<!--TODO: раскоментировать при реализации карточки услуг-->
												<!--<boxenv:linkToCard value="#{serviceItem.services}" text="#{serviceItem.services.name}"/>-->
												<h:outputText value="#{serviceItem.name}" styleClass="m-disp-block m-pad-bot5"/>
											</ui:repeat>
										</p:overlayPanel>
									</ui:fragment>
								</div>
							</p:column>

							<p:column styleClass="width-20">
								<p:commandLink styleClass="m-mar-right3" title="#{overallBundle['box.overall.delete']}"
											   disabled="#{not (p:ifGranted('Billing_SubscriptionEdit') and subscription.state eq subsState.FORMALIZATION)}"
											   action="#{subscriptionsFm.remove(subscription)}" update="subscriptions_table">
									<i class="fa fa-trash fs20 m-bold-gray" />
									<p:confirm header="#{subscriptionBundle['box.subscription.delete_dialog']}"
											   message="#{subscriptionBundle['box.subscription.delete_dialog.details']}"/>
								</p:commandLink>
							</p:column>
						</p:dataTable>

					</h:form>
				</div>
			</div>
		</div>
	</p:outputPanel>

	<ui:include src="/views/env/page/frame/NotGrantedFrame.xhtml">
		<ui:param name="headerIcon" value="icon-dehaze" />
		<ui:param name="headerText" value="#{subscriptionBundle['box.subscription.plural']}" />
		<ui:param name="permission" value="#{permissionRepository.getPermission('Billing_SubscriptionView')}" />
	</ui:include>

</ui:composition>