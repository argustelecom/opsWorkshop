<ui:component xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough" xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions" xmlns:o="http://omnifaces.org/ui"
	xmlns:sys="http://argustelecom.ru/system" xmlns:sysinf="http://argustelecom.ru/system-inf">

	<f:loadBundle var="activityBundle" basename="ActivityBundle"/>
	<p:outputPanel id="attachments_panel" styleClass="m-container100 fs14">

		<f:event listener="#{attachmentsFrm.preRender(attachmentsContext)}" type="preRenderComponent" />

		<p:fileUpload fileUploadListener="#{attachmentsFrm.handleFileUpload}" mode="advanced"
			rendered="#{attachmentsAppendable}" dragDropSupport="false" multiple="true" update="attachments_table"
			label="#{overallBundle['box.overall.choose_file']}" uploadLabel="#{overallBundle['box.overall.upload']}"
					  cancelLabel="#{overallBundle['box.overall.cancel']}" auto="false"
			sizeLimit="#{attachmentsSizeLimit == null ? 104857600 : attachmentsSizeLimit}"
			onstart="Argus.System.BlockUI.block();" oncomplete="Argus.System.BlockUI.unblock();" widgetVar="fileUploaderVar" />

		<!-- 
			http://stackoverflow.com/questions/30500731/file-upload-with-multiple-files-fails-in-primefaces-5-1
			Делаем загрузку файлов последовательной 
		-->
		<ui:define name="head">
			<h:outputScript>
				$(function () {
				PF('fileUploaderVar').jq.data().blueimpFileupload.options.sequentialUploads = true;
				});
			</h:outputScript>
		</ui:define>

		<p:dataTable id="attachments_table" value="#{attachmentsFrm.attachments}" var="attachment" styleClass="m-wid100"
					 tableStyle="table-layout: auto;" emptyMessage="#{activityBundle['box.activity.attachment.empty']}" sortMode="single"
					 scrollable="#{attachmentsScrollable}" scrollHeight="#{attachmentsScrollHeight}">

			<p:column styleClass="width-60-percents" headerText="#{activityBundle['box.activity.attachment.filename']}">
				<h:outputText value="#{attachment.fileName}" />
			</p:column>

			<p:column styleClass="width-20-percents" headerText="#{activityBundle['box.activity.attachment.added_by']}">
				<h:outputText value="#{attachment.author.objectName}" />
			</p:column>

			<p:column styleClass="width-15-percents" headerText="#{activityBundle['box.activity.attachment.is_added']}">
				<h:outputText value="#{attachment.creationDate}">
					<sysinf:convertDateTime pattern="#{dateUtils.DATETIME_DEFAULT_PATTERN}" timeZone="#{TZ.userTimeZone}" />
				</h:outputText>
			</p:column>

			<p:column styleClass="width-64" style="padding:3px !important;">
				<p:commandButton title="#{overallBundle['box.overall.download']}" ajax="false" icon="fa fa-download"
								 styleClass="m-mar-right3 m-fleft">
					<p:fileDownload value="#{attachmentsFrm.getStreamedContent(attachment)}" />
				</p:commandButton>

				<p:commandButton title="#{overallBundle['box.overall.delete']}" action="#{attachmentsFrm.removeAttachment(attachment)}"
					icon="fa fa-remove" styleClass="m-fleft" update="@namingcontainer">
					<p:confirm header="#{activityBundle['box.activity.attachment.delete_dialog']}"
						message="#{activityBundle['box.activity.attachment.delete_dialog.details']} '#{attachment.fileName}'?" />
				</p:commandButton>
			</p:column>

		</p:dataTable>
	</p:outputPanel>
</ui:component>