<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions" xmlns:o="http://omnifaces.org/ui"
	xmlns:sysinf="http://argustelecom.ru/system-inf" xmlns:pm="http://primefaces.org/modena"
	xmlns:f="http://java.sun.com/jsf/core" xmlns:boxenv="http://argustelecom.ru/box/env">

	<f:loadBundle var="activityBundle" basename="ActivityBundle"/>
	<p:outputPanel id="comments_panel" styleClass="m-container100 fs14 comments-panel">
		<f:event listener="#{commentsFrm.preRender(commentsContext)}" type="preRenderComponent" />

		<div class="m-container100 comment_control_panel">
			<h:inputText styleClass="visibility-hidden width-0"/>
			<p:outputLabel for="comment_filter_from" value="#{overallBundle['box.overall.valid_from']}: "/>
			<p:calendar id="comment_filter_from" value="#{commentsFrm.filterFrom}"
						pattern="#{dateUtils.DATETIME_DEFAULT_PATTERN}" styleClass="m-mar-right20"
						locale="#{languageBean.locale.language}"/>
			<p:outputLabel for="comment_filter_to" value="#{overallBundle['box.overall.valid_to.short']}:"
						   styleClass="m-mar-right10" />
			<p:calendar id="comment_filter_to" value="#{commentsFrm.filterTo}"
						pattern="#{dateUtils.DATETIME_DEFAULT_PATTERN}" styleClass="m-mar-right30"
						locale="#{languageBean.locale.language}"/>
			<p:commandLink id="filter_comment" styleClass="m-mar-left10"
						   action="#{commentsFrm.filter()}" update="@(.comments-panel)"
						   title="#{overallBundle['box.overall.search']}" >
				<i class="fa fa-filter icon-btn"/>
			</p:commandLink>

			<p:commandLink id="drop_filter_comment" styleClass="m-mar-left10"
						   action="#{commentsFrm.clearFilters()}" update="@(.comments-panel)"
						   title="#{overallBundle['box.overall.clear']}" disabled="#{not commentsFrm.filtered}" >
				<i class="fa fa-eraser icon-btn"/>
			</p:commandLink>

			<p:commandLink id="add_comment" styleClass="m-mar-left10 m-fright"
						   oncomplete="PF('commentEditDlgVar').show()" update="comment_edit_form" action="#{commentsFrm.clearFilters()}"
						   title="#{overallBundle['box.overall.add']}" disabled="#{commentsFrm.filtered}">
				<i class="fa fa-commenting icon-btn"/>
				<f:setPropertyActionListener value="#{commentsFrm.context}" target="#{commentEditDlg.commentContext}" />
				<f:setPropertyActionListener value="#{null}" target="#{commentEditDlg.comment}" />
			</p:commandLink>
		</div>

		<div class="m-container100 m-mar-top10">
			<p:dataScroller id="comment_scroller" value="#{commentsFrm.comments}" var="comment" mode="inline"
							styleClass="comment-scroller" chunkSize="#{commentsPageSize == null ? 5 : commentsPageSize}"
							scrollHeight="#{commentsHeight == null ? '300' : commentsHeight}">

				<f:facet name="loader">
					<p:commandButton type="button" styleClass="m-blue-text-button" value="#{overallBundle['box.overall.prev']}" />
				</f:facet>

				<p:outputPanel id="comment_container" class="comment-container">
					<div class="comment-header">
						<span class="data-overflow-ellipsis width-90-percents" title="#{comment.header}">#{comment.header}</span>

						<p:outputPanel styleClass="m-tex-al-right m-fright">
							<p:commandLink id="edit_comment" styleClass="m-mar-left10 m-mar-right5"
										   oncomplete="PF('commentEditDlgVar').show()" update="comment_edit_form"
										   action="#{commentsFrm.clearCommentHtml(comment)}"
										   title="#{overallBundle['box.overall.edit']}">
								<i class="icon-create icon-btn"/>
								<f:setPropertyActionListener value="#{commentsFrm.context}" target="#{commentEditDlg.commentContext}" />
								<f:setPropertyActionListener value="#{comment}" target="#{commentEditDlg.comment}" />
							</p:commandLink>

							<p:commandLink styleClass="m-mar-left10" action="#{commentsFrm.removeComment(comment)}"
										   update="@(.comments-panel)" title="#{overallBundle['box.overall.delete']}">
								<i class="fa fa-trash icon-btn"/>
								<p:confirm header="#{activityBundle['box.activity.comment.delete_dialog']}"
										   message="#{activityBundle['box.activity.comment.delete_dialog.details']}" />
							</p:commandLink>
						</p:outputPanel>
					</div>

					<p:outputPanel styleClass="columns fs14">
						<div class="column width-150 comment-status-container">
							<div class="comment-author-name">
								<o:importConstants type="ru.argustelecom.box.env.party.model.role.PartyRoleRepository"/>

								<ui:fragment rendered="#{comment.author.id.equals(PartyRoleRepository.QUEUE_USER_ID)}">
									<h:outputText value="#{comment.author.party.sortName}" />
								</ui:fragment>

								<ui:fragment rendered="#{!comment.author.id.equals(PartyRoleRepository.QUEUE_USER_ID)}">
									<boxenv:linkToCard value="#{comment.author}" text="#{comment.author.objectName}"/>
								</ui:fragment>
							</div>
							<p:outputPanel styleClass="comment-author-appointment" rendered="#{comment.author.appointment != null}">
								<h:outputText value="#{comment.author.appointment.objectName}" />
							</p:outputPanel>
							<div class="comment-time">
								<h:outputText value="#{dateUtils.format(comment.creationDate, dateUtils.TIME_DEFAULT_PATTERN, TZ.userTimeZone)}" />
							</div>
							<div class="comment-date">
								<h:outputText value="#{dateUtils.format(comment.creationDate, dateUtils.DATE_DEFAULT_PATTERN, TZ.userTimeZone)}" />
							</div>
						</div>

						<div class="column comment-content-container">
							<div class="comment-content">
								<h:outputText value="#{commentsFrm.getCommentHtml(comment)}" escape="false" />
							</div>
							<p:outputPanel styleClass="comment-editor" rendered="#{comment.editor != null}">
								<h:outputText
										value="#{activityBundle['box.activity.comment.edited']} #{dateUtils.format(comment.editDate, dateUtils.DATETIME_DEFAULT_PATTERN, TZ.userTimeZone)} #{activityBundle['box.activity.comment.edited_by']} #{comment.editor.objectName}" />
							</p:outputPanel>
						</div>
					</p:outputPanel>
				</p:outputPanel>
			</p:dataScroller>
		</div>

	</p:outputPanel>

</ui:composition>