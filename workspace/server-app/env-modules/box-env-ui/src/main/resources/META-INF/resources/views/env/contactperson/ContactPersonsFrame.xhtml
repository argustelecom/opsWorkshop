<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:o="http://omnifaces.org/ui" xmlns:sysinf="http://argustelecom.ru/system-inf"
                xmlns:pm="http://primefaces.org/modena" xmlns:f="http://java.sun.com/jsf/core">

	<f:loadBundle var="contactPersonBundle" basename="ContactPersonBundle"/>
	<p:outputPanel rendered="#{p:ifGranted('CRM_ContactPersonsView')}">
    	<div class="#{containerClass eq null ? 'm-container50' : containerClass} m-responsive100">
        	<div class="m-container-indent">
            	<div class="m-card m-shadow-effect m-hei-auto-on-mobile simple-fb">
                	<h:form id="contact_persons_form">
                    	<script>
                        	$( document ).ready(function() {
                            	Argus.System.BlockExpander.init('contact_persons_form');
                        	});
                    	</script>
                    	<ui:param name="companyId" value="#{contactPersonsFM.companyId}"/>

                    	<f:attribute name="updateEvent" value="#{currentPartyRole.changedEvent}"/>
                    	<f:event listener="#{contactPersonsFM.preRender(company)}" type="preRenderComponent"/>

                    	<div class="ui-dashboard-header">
                        	<i class="icon-contact_phone"/>
                        	<h:outputText  styleClass="card-header" value="#{contactPersonBundle['box.contact.person']}"/>
                        	<h:outputText  id="cpttp" class="icon-help_outline tooltip-help-15" position="top"
                                       title="#{contactPersonBundle['box.contact.person.hint']}"/>
                        	<p:tooltip id="contact_pers_ttp" for="cpttp" />

                        	<p:outputPanel styleClass="m-fright" rendered="#{canEdit}">
                            	<p:commandLink title="#{overallBundle['box.overall.add']}"
                                           	   process="@this" action="#{contactPersonEditDM.open()}" rendered="#{p:ifGranted('CRM_ContactPersonsEdit')}">
                                			   <i class="fa fa-pencil-square-o icon-btn"/>
                                	<f:setPropertyActionListener value="#{contactPersonsFM.companyId}" target="#{contactPersonEditDM.companyId}"/>
                                	<f:setPropertyActionListener value="#{contactPersonsFM.callback}" target="#{contactPersonEditDM.callback}"/>
                            	</p:commandLink>

                        	</p:outputPanel>
                    	</div>

						<p:outputPanel id="contact_persons_panel" styleClass="contact-person-list">
                        	<ui:repeat value="#{contactPersonsFM.cpDto.values}" var="contactPerson">
                            	<p:outputPanel class="m-disp-table width-100-percents contact-person-item">
                                	<div class="m-disp-table-cell width-55">
                                    	<p:graphicImage value="#{avatarUri.avatar}" styleClass="contact-person-avatar" cache="false">
                                        	<f:param name="#{avatarUri.personIdParamName}"
													 value="#{contactPerson.imageInputStream != null ? contactPerson.personId : avatarUri.defaultPersonId}"/>
                                    	</p:graphicImage>
                                	</div>
                                	<div class="m-disp-table-cell width-40-percents">
                                    	<p:commandLink process="@this" action="#{contactPersonViewDM.open()}">
                                        	<f:setPropertyActionListener value="#{contactPerson}" target="#{contactPersonViewDM.cpdDto}"/>

                                        	<div class="contact-person-name">
                                            	<h:outputText  value="#{contactPerson.lastName}"
                                                               title="#{contactPerson.lastName}"
                                                               styleClass="contact-person-last-name"/>
                                            	<h:outputText  value="#{contactPerson.firstName}"
                                                        	   title="#{contactPerson.firstName}"
                                                        	   styleClass="contact-person-first-name"/>
                                        	</div>
                                    	</p:commandLink>
                                	</div>
                                	<div class="m-disp-table-cell">
                                    	<p:link value="#{contactPerson.email}" title="#{contactPerson.email}" 
                                    			href="#{contactPerson.mailTo}" styleClass="m-disp-inl-block contact-person-email"/>
                                	</div>
                                	<div class="m-disp-table-cell">
                                    	<p:link value="#{contactPerson.phone}" title="#{contactPerson.phone}" 
                                    			href="#{contactPerson.callTo}" styleClass="m-disp-inl-block contact-person-phone"/>
                                	</div>
                                	<div class="m-disp-table-cell width-50 m-tex-al-right">
                                    	<p:commandLink styleClass="m-mar-right10" title="#{overallBundle['box.overall.edit']}"
                                                   	   action="#{contactPersonEditDM.open()}" process="@this"
                                                   	   rendered="#{p:ifGranted('CRM_ContactPersonsEdit')}">
                                        	<i class="icon-create fs18"/>
                                        	<f:setPropertyActionListener value="#{contactPerson}" target="#{contactPersonEditDM.editableObject}"/>
											<f:setPropertyActionListener value="#{contactPersonsFM.callback}" target="#{contactPersonEditDM.callback}"/>
                                    	</p:commandLink>
                                    	<p:commandLink title="#{overallBundle['box.overall.delete']}" process="@this" styleClass="remove-item"
                                                   	   action="#{contactPersonsFM.remove(contactPerson)}" update="contact_persons_form-contact_persons_panel contact_persons_form"
                                                   	   rendered="#{p:ifGranted('CRM_ContactPersonsEdit')}">
                                        	<i class="fa fa-trash-o fs18"/>
                                    	</p:commandLink>
                                	</div>
                            	</p:outputPanel>
                        	</ui:repeat>
                    	</p:outputPanel>
						<p:commandLink title="#{overallBundle['box.overall.maximize']}" onclick='Argus.System.BlockExpander.containerToggler()'
									   rendered="#{p:ifGranted('CRM_ContactPersonsEdit') and not empty contactPersonsFM.cpDto.values}" styleClass="card-toggler m-disp-block">
							<i class="icon-ellipsis"/>
						</p:commandLink>
                	</h:form>
            	</div>
        	</div>
    	</div>
    </p:outputPanel>

    <ui:include src="/views/env/page/frame/NotGrantedFrame.xhtml">
		<ui:param name="headerIcon" value="icon-contact_phone" />
		<ui:param name="headerText" value="#{contactPersonBundle['box.contact.person']}" />
		<ui:param name="permission" value="#{permissionRepository.getPermission('CRM_ContactPersonsView')}" />
	</ui:include>

</ui:composition>