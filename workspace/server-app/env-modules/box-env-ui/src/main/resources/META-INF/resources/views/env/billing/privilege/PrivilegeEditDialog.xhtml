<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.org/ui" xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:o="http://omnifaces.org/ui" xmlns:sysinf="http://argustelecom.ru/system-inf"
                xmlns:pm="http://primefaces.org/modena" xmlns:f="http://java.sun.com/jsf/core">

    <h:form id="privilege_edit_form">
        <p:dialog id="privilege_edit_dlg" header="#{privilegeEditDm.dialogHeader}" width="600" styleClass="icon-creation"
                  widgetVar="privilegeEditDlgVar" resizable="false" modal="true" closable="false" dynamic="true">

			<o:importConstants type="ru.argustelecom.box.env.billing.privilege.PrivilegeTypeRef" var="privilegeType"/>

			<p:outputPanel id="message_panel">
				<ui:fragment rendered="#{privilegeEditDm.privilege.type eq privilegeType.TRUST_PERIOD}">
					<div class="message message-bg-info message-info message-icon message-icon-info">
						<p>#{privilegeBundle['box.privilege.trust_period.hint']}</p>
					</div>
				</ui:fragment>

				<ui:fragment rendered="#{privilegeEditDm.privilege.type eq privilegeType.DISCOUNT}">
					<ui:fragment rendered="#{not privilegeEditDm.validFromGreatLastClosedInvoiceEndDate}">
						<div class="message message-bg-info message-info message-icon message-icon-info">
							<p>#{privilegeBundle['box.privilege.discount.valid_from.hint']}
								<h:outputText value="#{privilegeEditDm.discountPossibleStartDate}">
									<sysinf:convertDateTime pattern="#{dateUtils.DATE_DEFAULT_PATTERN}"/>
								</h:outputText>
							</p>
						</div>
					</ui:fragment>

					<ui:fragment rendered="#{privilegeEditDm.discountIntersectionWithOpenInvoice}">
						<div class="message message-bg-warn message-warn message-icon message-icon-warn">
							<p>#{privilegeBundle['box.privilege.discount.edit.hint']}
								<ui:fragment rendered="#{privilegeEditDm.reserveFunds}">
									#{privilegeBundle['box.privilege.discount.edit.reserve.hint']}
								</ui:fragment>
							</p>
						</div>
					</ui:fragment>
				</ui:fragment>
			</p:outputPanel>

            <dl class="name-value width-150">
				<h:inputText styleClass="visibility-hidden width-0 no-bg-and-borders"/>
				<dt>
					<p:outputLabel value="#{overallBundle['box.overall.object']}:"/>
				</dt>
				<dd>
					<h:outputText value="#{privilegeEditDm.subject.name}"/>
				</dd>

				<dt>
					<p:outputLabel value="#{privilegeBundle['box.privilege.type']}:"/>
				</dt>
				<dd>
					<p:selectOneMenu value="#{privilegeEditDm.privilege.type}" required="true" disabled="#{privilegeEditDm.editMode || not privilegeEditDm.canCreateDiscount()}">

						<p:ajax event="change" process="@this" listener="#{privilegeEditDm.onTypeChanged()}"
								update="message_panel rate_of_discount_panel valid_from valid_to ignore_warns_panel create_button"/>

						<f:selectItem itemValue=""/>
						<f:selectItem itemValue="#{privilegeType.TRUST_PERIOD}" itemLabel="#{privilegeType.TRUST_PERIOD.name}"/>
						<f:selectItem itemValue="#{privilegeType.DISCOUNT}" itemLabel="#{privilegeType.DISCOUNT.name}"/>
					</p:selectOneMenu>
				</dd>

				<dt>
					<p:outputLabel for="valid_from" value="#{overallBundle['box.overall.valid_from']}:"/>
				</dt>
				<dd>
					<p:calendar id="valid_from" value="#{privilegeEditDm.privilege.validFrom}"
								required="true" pattern="#{privilegeEditDm.datePattern}" styleClass="width-40-percents"
								locale="ru" label="#{overallBundle['box.overall.valid_from']}" 
								mindate="#{privilegeEditDm.minDate}" disabled="#{privilegeEditDm.editMode}">
						<p:ajax event="dateSelect" process="@this" listener="#{privilegeEditDm.checkDiscountIntersectionWithOpenInvoice}"
								update="valid_to message_panel ignore_warns_panel create_button"/>
						<p:ajax partialSubmit="true" process="@this" listener="#{privilegeEditDm.checkDiscountIntersectionWithOpenInvoice}"
								update="valid_to message_panel ignore_warns_panel create_button"/>
					</p:calendar>

					<p:outputLabel for="valid_to" value="#{overallBundle['box.overall.valid_to.short']}:" 
								   styleClass="m-tex-al-right width-17-percents"/>
					<p:calendar id="valid_to" value="#{privilegeEditDm.privilege.validTo}" required="true"
								pattern="#{privilegeEditDm.datePattern}" styleClass="width-40-percents"
								mindate="#{privilegeEditDm.privilege.validFrom}" locale="ru" 
								label="#{overallBundle['box.overall.valid_to']}">
						<p:ajax event="dateSelect" process="@this" listener="#{privilegeEditDm.checkDiscountIntersectionWithOpenInvoice}"
								update="message_panel ignore_warns_panel ignore_warns_panel create_button"/>
						<p:ajax partialSubmit="true" process="@this" listener="#{privilegeEditDm.checkDiscountIntersectionWithOpenInvoice}"
								update="message_panel ignore_warns_panel ignore_warns_panel create_button"/>
					</p:calendar>
				</dd>
            </dl>

			<p:outputPanel id="rate_of_discount_panel">
				<ui:fragment rendered="#{privilegeEditDm.privilege.type eq privilegeType.DISCOUNT}">
					<dl class="name-value width-150">
						<dt>
							<p:outputLabel value="#{privilegeBundle['box.privilege.discount.rate']}:"/>
						</dt>
						<dd>
							<p:inputText id="rate_of_discount" value="#{privilegeEditDm.privilege.rateOfDiscount}"
										 required="true" styleClass="width-160" label="#{privilegeBundle['box.privilege.discount.rate']}">
								<f:converter converterId="javax.faces.BigDecimal" />
								<f:validateDoubleRange minimum="0.00" maximum="100.00"/>
							</p:inputText>
							%
						</dd>
					</dl>
				</ui:fragment>
			</p:outputPanel>

			<p:outputPanel id="ignore_warns_panel">
				<ui:fragment rendered="#{privilegeEditDm.discountIntersectionWithOpenInvoice and privilegeEditDm.privilege.type eq privilegeType.DISCOUNT}">
					<dl class="name-value width-220">
						<dt>
							<p:outputLabel for="ignore_warns" value="#{privilegeBundle['box.privilege.acquainted']}:"/>
						</dt>
						<dd>
							<p:selectBooleanCheckbox id="ignore_warns" value="#{privilegeEditDm.ignoreWarns}">
								<p:ajax process="@this" update="create_button"/>
							</p:selectBooleanCheckbox>
						</dd>
					</dl>
				</ui:fragment>
			</p:outputPanel>

            <div class="dialog-footer-buttons">
                <p:commandButton id="cancel_button" value="#{overallBundle['box.overall.cancel']}"
                                 styleClass="m-blue-text-button" process="@this" action="#{privilegeEditDm.cancel()}"
                                 onclick="PF('privilegeEditDlgVar').hide();"/>
                <p:commandButton id="create_button" value="#{overallBundle['box.overall.create']}"
								 disabled="#{privilegeEditDm.disableCreation}" action="#{privilegeEditDm.submit()}"
								 process="privilege_edit_dlg" update="#{update} @this message_panel ignore_warns_panel"/>
            </div>

        </p:dialog>
	</h:form>

</ui:composition>